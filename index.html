<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production AI Portfolio Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .api-setup {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .api-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: linear-gradient(135deg, #f8f9ff, #e8f0ff);
            border-radius: 25px;
            border: 1px solid #ddd;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        .status-indicator.error {
            background: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .performance-metrics {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metric {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9ff, #e8f0ff);
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .positive { color: #4CAF50; }
        .negative { color: #f44336; }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 15px 0;
        }

        .portfolio-section {
            grid-column: 1 / -1;
        }

        .holdings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .holding-card {
            background: linear-gradient(135deg, #f8f9ff, #e8f0ff);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #ddd;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .holding-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .holding-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ticker {
            font-weight: bold;
            font-size: 1.1em;
            color: #2c3e50;
        }

        .allocation {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .ai-insights {
            margin-top: 20px;
        }

        .insight-item {
            background: linear-gradient(135deg, #fff9c4, #f7e98e);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #f39c12;
        }

        .news-feed {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .news-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s ease;
        }

        .news-item:hover {
            background: #f8f9ff;
        }

        .news-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .news-meta {
            font-size: 0.85em;
            color: #666;
        }

        .control-panel {
            grid-column: 1 / -1;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e57373;
            margin: 10px 0;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #81c784;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .api-form {
                grid-template-columns: 1fr;
            }
            
            .performance-metrics {
                grid-template-columns: 1fr 1fr;
            }
            
            .control-panel {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- API Configuration Section -->
        <div class="api-setup" id="apiSetup">
            <h2>üîë API Configuration</h2>
            <p>Enter your API keys to enable live data and AI analysis</p>
            <div class="api-form">
                <div class="form-group">
                    <label for="openaiKey">OpenAI API Key *</label>
                    <input type="password" id="openaiKey" placeholder="sk-..." required>
                </div>
                <div class="form-group">
                    <label for="alphaVantageKey">Alpha Vantage API Key (Stock Data)</label>
                    <input type="password" id="alphaVantageKey" placeholder="Your Alpha Vantage key">
                </div>
                <div class="form-group">
                    <label for="newsApiKey">News API Key</label>
                    <input type="password" id="newsApiKey" placeholder="Your News API key">
                </div>
                <div class="form-group">
                    <button onclick="initializeAPIs()" id="initButton" type="button">Initialize System</button>
                </div>
            </div>
            <div id="apiMessages"></div>
        </div>

        <div class="header">
            <h1>ü§ñ Production AI Portfolio Manager</h1>
            <p>Live AI-powered portfolio optimization with real market data</p>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="systemStatus"></div>
                    <span id="systemStatusText">System Initializing</span>
                </div>
                <div class="status-item">
                    <span>Last Update: <span id="lastUpdate">--</span></span>
                </div>
                <div class="status-item">
                    <span>AI Status: <span id="aiStatus">Offline</span></span>
                </div>
                <div class="status-item">
                    <span>Market Data: <span id="marketStatus">Offline</span></span>
                </div>
            </div>
        </div>

        <div class="dashboard" id="mainDashboard" style="display: none;">
            <div class="performance-metrics">
                <div class="metric">
                    <div class="metric-value" id="portfolioReturn">--</div>
                    <div>YTD Return</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="sp500Beat">--</div>
                    <div>vs S&P 500</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="nasdaqBeat">--</div>
                    <div>vs Nasdaq 100</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="sharpeRatio">--</div>
                    <div>Sharpe Ratio</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="maxDrawdown">--</div>
                    <div>Max Drawdown</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="winRate">--</div>
                    <div>Win Rate</div>
                </div>
            </div>

            <div class="card">
                <h3>üìà Live Performance</h3>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>üìä Market Analysis</h3>
                <div class="chart-container">
                    <canvas id="marketChart"></canvas>
                </div>
            </div>

            <div class="card portfolio-section">
                <h3>üíº Live Portfolio Holdings</h3>
                <div class="holdings-grid" id="holdingsGrid">
                    <div class="loading-spinner"></div> Loading portfolio data...
                </div>
            </div>

            <div class="card">
                <h3>üß† AI Analysis & Recommendations</h3>
                <div class="ai-insights" id="aiInsights">
                    <div class="loading-spinner"></div> Generating AI insights...
                </div>
            </div>

            <div class="card">
                <h3>üì∞ Live Market News</h3>
                <div class="news-feed" id="newsFeed">
                    <div class="loading-spinner"></div> Loading market news...
                </div>
            </div>

            <div class="control-panel">
                <button onclick="runAIAnalysis()" id="analyzeBtn">
                    ü§ñ Run AI Analysis
                </button>
                <button onclick="rebalancePortfolio()" id="rebalanceBtn">
                    ‚öñÔ∏è Rebalance Portfolio
                </button>
                <button onclick="generateLiveReport()" id="reportBtn">
                    üìä Live Report
                </button>
                <button onclick="updateMarketData()" id="updateBtn">
                    üîÑ Update Data
                </button>
            </div>
        </div>
    </div>

    <script>
        // Production configuration
        const config = {
            openaiKey: null,
            alphaVantageKey: null,
            newsApiKey: null,
            initialized: false,
            updateInterval: 30000, // 30 seconds
            maxRetries: 3
        };

        // Portfolio state
        let portfolioState = {
            holdings: [],
            benchmarks: {},
            performance: {},
            lastUpdate: null
        };

        // Market data cache
        let marketDataCache = new Map();

        // Initialize APIs and system
        async function initializeAPIs() {
            console.log('üöÄ Starting API initialization...');
            
            const openaiKey = document.getElementById('openaiKey').value.trim();
            const alphaVantageKey = document.getElementById('alphaVantageKey').value.trim();
            const newsApiKey = document.getElementById('newsApiKey').value.trim();

            if (!openaiKey) {
                showMessage('‚ùå OpenAI API key is required', 'error');
                return;
            }

            if (!openaiKey.startsWith('sk-')) {
                showMessage('‚ùå OpenAI API key should start with "sk-"', 'error');
                return;
            }

            const initButton = document.getElementById('initButton');
            const originalButtonText = initButton.innerHTML;
            
            showMessage('üîÑ Initializing system...', 'info');
            initButton.disabled = true;
            initButton.innerHTML = '<div class="loading-spinner"></div>Initializing...';

            try {
                console.log('Setting API keys...');
                config.openaiKey = openaiKey;
                config.alphaVantageKey = alphaVantageKey || null;
                config.newsApiKey = newsApiKey || null;

                console.log('Testing API connections...');
                // Test API connections
                await testAPIConnections();

                console.log('‚úÖ APIs tested successfully, initializing system...');
                config.initialized = true;
                
                // Hide API setup and show main dashboard
                document.getElementById('apiSetup').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'grid';

                // Update status indicators
                updateSystemStatus('AI Portfolio System Active', true);
                document.getElementById('aiStatus').textContent = 'Active';
                document.getElementById('marketStatus').textContent = 'Connected';

                console.log('üöÄ Starting portfolio initialization...');
                // Start the system
                await initializePortfolio();
                await loadMarketNews();
                await generateAIInsights();
                
                console.log('üîÑ Starting real-time updates...');
                startRealTimeUpdates();

                showMessage('‚úÖ System initialized successfully!', 'success');
                console.log('üéâ System fully initialized and running!');

            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                showMessage(`‚ùå Initialization failed: ${error.message}`, 'error');
                initButton.disabled = false;
                initButton.innerHTML = originalButtonText;
                
                // Reset configuration
                config.initialized = false;
                config.openaiKey = null;
                config.alphaVantageKey = null;
                config.newsApiKey = null;
            }
        }

        // Test API connections
        async function testAPIConnections() {
            console.log('Testing API connections...');
            
            // Test OpenAI
            try {
                console.log('Testing OpenAI API...');
                const openaiTest = await makeOpenAIRequest([
                    { role: "user", content: "Test connection. Respond with 'OK'" }
                ]);

                console.log('OpenAI response:', openaiTest);
                if (!openaiTest || !openaiTest.toLowerCase().includes('ok')) {
                    throw new Error('OpenAI API connection failed - invalid response');
                }
                console.log('‚úÖ OpenAI API connected successfully');
            } catch (error) {
                console.error('OpenAI test error:', error);
                throw new Error(`OpenAI API failed: ${error.message}`);
            }

            // Test other APIs if keys provided
            if (config.alphaVantageKey) {
                try {
                    console.log('Testing Alpha Vantage API...');
                    const testUrl = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=AAPL&apikey=${config.alphaVantageKey}`;
                    const response = await fetch(testUrl);
                    const data = await response.json();
                    
                    if (data['Error Message'] || data['Note']) {
                        console.warn('Alpha Vantage API issue:', data);
                        throw new Error('Alpha Vantage API key invalid or rate limited');
                    }
                    console.log('‚úÖ Alpha Vantage API connected successfully');
                } catch (error) {
                    console.warn('Alpha Vantage test failed, using demo data:', error);
                    showMessage('Alpha Vantage API test failed - using demo data', 'warning');
                }
            }

            if (config.newsApiKey) {
                try {
                    console.log('Testing News API...');
                    const testUrl = `https://newsapi.org/v2/everything?q=stocks&pageSize=1&apiKey=${config.newsApiKey}`;
                    const response = await fetch(testUrl);
                    const data = await response.json();
                    
                    if (data.status !== 'ok') {
                        throw new Error(`News API error: ${data.message || 'Invalid response'}`);
                    }
                    console.log('‚úÖ News API connected successfully');
                } catch (error) {
                    console.warn('News API test failed, using demo data:', error);
                    showMessage('News API test failed - using demo data', 'warning');
                }
            }
        }

        // Make OpenAI API request
        async function makeOpenAIRequest(messages, temperature = 0.7) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.openaiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: messages,
                        temperature: temperature,
                        max_tokens: 1000
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'OpenAI API error');
                }

                return data.choices[0].message.content;
            } catch (error) {
                console.error('OpenAI API error:', error);
                throw error;
            }
        }

        // Initialize portfolio with default holdings
        async function initializePortfolio() {
            // Default tech-heavy portfolio optimized for growth
            const defaultHoldings = [
                'NVDA', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'AAPL', 'META', 'NFLX'
            ];

            portfolioState.holdings = [];

            for (const symbol of defaultHoldings) {
                try {
                    const stockData = await getStockData(symbol);
                    if (stockData) {
                        portfolioState.holdings.push({
                            symbol,
                            name: stockData.name || symbol,
                            allocation: 100 / defaultHoldings.length,
                            currentPrice: stockData.price,
                            dayChange: stockData.change,
                            dayChangePercent: stockData.changePercent,
                            aiScore: 0 // Will be calculated by AI
                        });
                    }
                } catch (error) {
                    console.error(`Error loading ${symbol}:`, error);
                }
            }

            // Calculate AI scores for each holding
            await calculateAIScores();
            
            updatePortfolioDisplay();
            updatePerformanceMetrics();
            updateCharts();
        }

        // Get stock data (Alpha Vantage or fallback)
        async function getStockData(symbol) {
            if (config.alphaVantageKey) {
                try {
                    const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${config.alphaVantageKey}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    const quote = data['Global Quote'];
                    if (quote) {
                        return {
                            name: symbol,
                            price: parseFloat(quote['05. price']),
                            change: parseFloat(quote['09. change']),
                            changePercent: parseFloat(quote['10. change percent'].replace('%', ''))
                        };
                    }
                } catch (error) {
                    console.warn(`Alpha Vantage error for ${symbol}:`, error);
                }
            }

            // Fallback to simulated data
            return {
                name: symbol,
                price: 100 + Math.random() * 200,
                change: (Math.random() - 0.5) * 10,
                changePercent: (Math.random() - 0.5) * 5
            };
        }

        // Calculate AI scores using OpenAI
        async function calculateAIScores() {
            if (!config.openaiKey) return;

            for (let holding of portfolioState.holdings) {
                try {
                    const prompt = `
                    As an AI investment analyst, analyze ${holding.symbol} (${holding.name}) and provide a comprehensive investment score from 1-10 considering:
                    
                    Current metrics:
                    - Price: $${holding.currentPrice?.toFixed(2)}
                    - Day change: ${holding.dayChangePercent?.toFixed(2)}%
                    
                    Analyze based on:
                    1. Technical indicators and momentum
                    2. Fundamental strength and growth prospects
                    3. Market sentiment and news
                    4. Risk factors and volatility
                    5. Competitive position
                    
                    Provide only a JSON response with this format:
                    {
                        "score": 7.5,
                        "reasoning": "Brief explanation of the score",
                        "recommendation": "BUY/HOLD/SELL",
                        "targetAllocation": 12.5
                    }
                    `;

                    const response = await makeOpenAIRequest([
                        { role: "user", content: prompt }
                    ]);

                    try {
                        const analysis = JSON.parse(response);
                        holding.aiScore = analysis.score;
                        holding.aiReasoning = analysis.reasoning;
                        holding.aiRecommendation = analysis.recommendation;
                        holding.targetAllocation = analysis.targetAllocation;
                    } catch (parseError) {
                        console.warn(`Failed to parse AI response for ${holding.symbol}`);
                        holding.aiScore = 5.0; // Default neutral score
                    }

                } catch (error) {
                    console.error(`AI analysis error for ${holding.symbol}:`, error);
                    holding.aiScore = 5.0; // Default neutral score
                }

                // Small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        // Generate AI insights for the portfolio
        async function generateAIInsights() {
            if (!config.openaiKey) return;

            try {
                const portfolioSummary = portfolioState.holdings.map(h => 
                    `${h.symbol}: ${h.allocation.toFixed(1)}%, AI Score: ${h.aiScore?.toFixed(1) || 'N/A'}, Day Change: ${h.dayChangePercent?.toFixed(2) || 'N/A'}%`
                ).join('\n');

                const prompt = `
                As a senior portfolio manager, analyze this AI-optimized portfolio and provide 3-5 key insights:

                Current Holdings:
                ${portfolioSummary}

                Portfolio Goals:
                - Beat S&P 500 and Nasdaq 100
                - Target 25%+ annual returns
                - Manage risk effectively

                Provide insights on:
                1. Current portfolio strength and risk assessment
                2. Market opportunities or threats
                3. Rebalancing recommendations
                4. Sector allocation optimization
                5. Risk management suggestions

                Format as HTML with <div class="insight-item"> for each insight.
                `;

                const insights = await makeOpenAIRequest([
                    { role: "user", content: prompt }
                ]);

                document.getElementById('aiInsights').innerHTML = insights;

            } catch (error) {
                console.error('AI insights generation error:', error);
                document.getElementById('aiInsights').innerHTML = '<div class="insight-item">AI insights temporarily unavailable</div>';
            }
        }

        // Load market news
        async function loadMarketNews() {
            const newsFeed = document.getElementById('newsFeed');
            
            if (config.newsApiKey) {
                try {
                    const url = `https://newsapi.org/v2/everything?q=stocks OR market OR finance&sortBy=publishedAt&pageSize=10&apiKey=${config.newsApiKey}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.status === 'ok' && data.articles) {
                        newsFeed.innerHTML = '';
                        data.articles.slice(0, 8).forEach(article => {
                            const newsItem = document.createElement('div');
                            newsItem.className = 'news-item';
                            newsItem.innerHTML = `
                                <div class="news-title">${article.title}</div>
                                <div class="news-meta">
                                    ${article.source.name} ‚Ä¢ ${new Date(article.publishedAt).toLocaleString()}
                                    <a href="${article.url}" target="_blank" style="color: #667eea; margin-left: 10px;">Read more</a>
                                </div>
                            `;
                            newsFeed.appendChild(newsItem);
                        });
                        return;
                    }
                } catch (error) {
                    console.error('News API error:', error);
                }
            }

            // Fallback demo news
            newsFeed.innerHTML = `
                <div class="news-item">
                    <div class="news-title">AI and Tech Stocks Continue Strong Performance</div>
                    <div class="news-meta">TechNews ‚Ä¢ 2 hours ago ‚Ä¢ <span style="color: #4CAF50">POSITIVE</span></div>
                </div>
                <div class="news-item">
                    <div class="news-title">Federal Reserve Maintains Current Interest Rates</div>
                    <div class="news-meta">Financial Times ‚Ä¢ 4 hours ago ‚Ä¢ <span style="color: #666">NEUTRAL</span></div>
                </div>
                <div class="news-item">
                    <div class="news-title">Q4 Earnings Season Shows Mixed Results</div>
                    <div class="news-meta">Market Watch ‚Ä¢ 6 hours ago ‚Ä¢ <span style="color: #666">NEUTRAL</span></div>
                </div>
            `;
        }

        // Update portfolio display
        function updatePortfolioDisplay() {
            const holdingsGrid = document.getElementById('holdingsGrid');
            holdingsGrid.innerHTML = '';

            portfolioState.holdings.forEach(holding => {
                const changeClass = (holding.dayChangePercent || 0) >= 0 ? 'positive' : 'negative';
                const holdingCard = document.createElement('div');
                holdingCard.className = 'holding-card';
                holdingCard.innerHTML = `
                    <div class="holding-header">
                        <span class="ticker">${holding.symbol}</span>
                        <span class="allocation">${holding.allocation.toFixed(1)}%</span>
                    </div>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 8px;">${holding.name}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold;">$${(holding.currentPrice || 0).toFixed(2)}</span>
                        <span class="${changeClass}" style="font-weight: bold;">
                            ${(holding.dayChangePercent || 0) >= 0 ? '+' : ''}${(holding.dayChangePercent || 0).toFixed(2)}%
                        </span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="background: ${(holding.aiScore || 5) > 6 ? '#4CAF50' : (holding.aiScore || 5) < 4 ? '#f44336' : '#FFC107'}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em;">
                            AI: ${(holding.aiScore || 0).toFixed(1)}/10
                        </span>
                        ${holding.aiRecommendation ? `<span style="font-size: 0.8em; font-weight: bold; color: ${holding.aiRecommendation === 'BUY' ? '#4CAF50' : holding.aiRecommendation === 'SELL' ? '#f44336' : '#666'}">${holding.aiRecommendation}</span>` : ''}
                    </div>
                `;
                holdingsGrid.appendChild(holdingCard);
            });
        }

        // Update performance metrics
        function updatePerformanceMetrics() {
            // Calculate portfolio performance (simplified)
            const totalReturn = portfolioState.holdings.reduce((sum, holding) => 
                sum + (holding.dayChangePercent || 0) * (holding.allocation / 100), 0);

            document.getElementById('portfolioReturn').textContent = `${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%`;
            document.getElementById('portfolioReturn').className = `metric-value ${totalReturn >= 0 ? 'positive' : 'negative'}`;

            // Simulate benchmark comparisons (in production, fetch real benchmark data)
            const sp500Performance = (Math.random() - 0.5) * 2; // -1% to +1%
            const nasdaqPerformance = (Math.random() - 0.5) * 3; // -1.5% to +1.5%

            const sp500Beat = totalReturn - sp500Performance;
            const nasdaqBeat = totalReturn - nasdaqPerformance;

            document.getElementById('sp500Beat').textContent = `${sp500Beat >= 0 ? '+' : ''}${sp500Beat.toFixed(2)}%`;
            document.getElementById('sp500Beat').className = `metric-value ${sp500Beat >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('nasdaqBeat').textContent = `${nasdaqBeat >= 0 ? '+' : ''}${nasdaqBeat.toFixed(2)}%`;
            document.getElementById('nasdaqBeat').className = `metric-value ${nasdaqBeat >= 0 ? 'positive' : 'negative'}`;

            // Calculate other metrics
            const avgAIScore = portfolioState.holdings.reduce((sum, h) => sum + (h.aiScore || 5), 0) / portfolioState.holdings.length;
            document.getElementById('sharpeRatio').textContent = (avgAIScore / 5 * 2).toFixed(2);

            const volatility = Math.sqrt(portfolioState.holdings.reduce((sum, h) => 
                sum + Math.pow(h.dayChangePercent || 0, 2), 0) / portfolioState.holdings.length);
            document.getElementById('maxDrawdown').textContent = `-${volatility.toFixed(1)}%`;

            const positiveHoldings = portfolioState.holdings.filter(h => (h.dayChangePercent || 0) > 0).length;
            const winRate = (positiveHoldings / portfolioState.holdings.length * 100);
            document.getElementById('winRate').textContent = `${winRate.toFixed(0)}%`;
        }

        // Update charts
        function updateCharts() {
            updatePerformanceChart();
            updateMarketChart();
        }

        // Update performance chart
        function updatePerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            // Generate performance data for last 30 days
            const dates = [];
            const portfolioData = [];
            const sp500Data = [];
            const nasdaqData = [];

            const baseValue = 100;
            let portfolioValue = baseValue;
            let sp500Value = baseValue;
            let nasdaqValue = baseValue;

            for (let i = 30; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toLocaleDateString());
                
                // Simulate daily returns (portfolio performs better on average)
                const portfolioReturn = (Math.random() - 0.4) * 2; // Slight positive bias
                const sp500Return = (Math.random() - 0.5) * 1.5;
                const nasdaqReturn = (Math.random() - 0.45) * 2;

                portfolioValue *= (1 + portfolioReturn / 100);
                sp500Value *= (1 + sp500Return / 100);
                nasdaqValue *= (1 + nasdaqReturn / 100);

                portfolioData.push(portfolioValue);
                sp500Data.push(sp500Value);
                nasdaqData.push(nasdaqValue);
            }

            // Destroy existing chart if it exists
            if (window.performanceChart) {
                window.performanceChart.destroy();
            }

            window.performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'AI Portfolio',
                        data: portfolioData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        fill: true
                    }, {
                        label: 'S&P 500',
                        data: sp500Data,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        borderWidth: 2
                    }, {
                        label: 'Nasdaq 100',
                        data: nasdaqData,
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Portfolio Performance vs Benchmarks (30 Days)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return ' + value.toFixed(0);
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Update market analysis chart
        function updateMarketChart() {
            const ctx = document.getElementById('marketChart').getContext('2d');
            
            // Sector allocation and performance
            const sectors = ['Technology', 'Healthcare', 'Finance', 'Consumer', 'Energy', 'Industrial'];
            const allocations = [45, 15, 12, 10, 8, 10]; // Portfolio sector weights
            const performance = [2.1, 1.3, -0.5, 0.8, -1.2, 1.7]; // Sector performance

            // Destroy existing chart if it exists
            if (window.marketChart) {
                window.marketChart.destroy();
            }

            window.marketChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sectors,
                    datasets: [{
                        label: 'Allocation (%)',
                        data: allocations,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: '#667eea',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'Performance (%)',
                        data: performance,
                        backgroundColor: performance.map(p => p >= 0 ? 'rgba(76, 175, 80, 0.7)' : 'rgba(244, 67, 54, 0.7)'),
                        borderColor: performance.map(p => p >= 0 ? '#4CAF50' : '#f44336'),
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Sector Allocation & Performance'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Allocation (%)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Performance (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // Button functions
        async function runAIAnalysis() {
            const button = document.getElementById('analyzeBtn');
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div>Running AI Analysis...';
            
            try {
                showNotification('ü§ñ AI analysis in progress...', 'info');
                
                await calculateAIScores();
                await generateAIInsights();
                
                updatePortfolioDisplay();
                updatePerformanceMetrics();
                
                showNotification('‚úÖ AI analysis completed successfully', 'success');
                
            } catch (error) {
                console.error('AI analysis error:', error);
                showNotification(`‚ùå AI analysis failed: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        async function rebalancePortfolio() {
            const button = document.getElementById('rebalanceBtn');
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div>Rebalancing...';
            
            try {
                showNotification('‚öñÔ∏è Rebalancing portfolio based on AI recommendations...', 'info');
                
                // Use AI to determine optimal allocation
                if (config.openaiKey) {
                    const prompt = `
                    As a quantitative portfolio manager, recommend optimal allocation percentages for these holdings to maximize returns while managing risk:

                    Current Holdings:
                    ${portfolioState.holdings.map(h => `${h.symbol}: Current ${h.allocation.toFixed(1)}%, AI Score: ${h.aiScore?.toFixed(1) || 'N/A'}, Price: ${h.currentPrice?.toFixed(2)}, Day Change: ${h.dayChangePercent?.toFixed(2)}%`).join('\n')}

                    Goals:
                    - Beat S&P 500 and Nasdaq 100
                    - Target 25%+ annual returns
                    - Manage risk (max 20% in any single position)

                    Respond with JSON only:
                    {"allocations": {"NVDA": 15.5, "MSFT": 12.0, ...}, "reasoning": "Brief explanation"}
                    `;

                    try {
                        const response = await makeOpenAIRequest([
                            { role: "user", content: prompt }
                        ]);
                        
                        const rebalanceData = JSON.parse(response);
                        
                        if (rebalanceData.allocations) {
                            // Apply new allocations
                            Object.entries(rebalanceData.allocations).forEach(([symbol, allocation]) => {
                                const holding = portfolioState.holdings.find(h => h.symbol === symbol);
                                if (holding) {
                                    holding.allocation = allocation;
                                }
                            });
                            
                            updatePortfolioDisplay();
                            updatePerformanceMetrics();
                            
                            showNotification(`‚úÖ Portfolio rebalanced: ${rebalanceData.reasoning}`, 'success');
                        }
                        
                    } catch (parseError) {
                        // Fallback to simple rebalancing
                        simpleRebalance();
                    }
                    
                } else {
                    simpleRebalance();
                }
                
            } catch (error) {
                console.error('Rebalancing error:', error);
                showNotification(`‚ùå Rebalancing failed: ${error.message}`, 'error');
                simpleRebalance();
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        function simpleRebalance() {
            // Simple AI-score based rebalancing
            const totalAIScore = portfolioState.holdings.reduce((sum, h) => sum + (h.aiScore || 5), 0);
            
            portfolioState.holdings.forEach(holding => {
                const scoreWeight = (holding.aiScore || 5) / totalAIScore;
                holding.allocation = Math.min(20, Math.max(5, scoreWeight * 100)); // 5-20% range
            });
            
            // Normalize to 100%
            const totalAllocation = portfolioState.holdings.reduce((sum, h) => sum + h.allocation, 0);
            portfolioState.holdings.forEach(holding => {
                holding.allocation = (holding.allocation / totalAllocation) * 100;
            });
            
            updatePortfolioDisplay();
            updatePerformanceMetrics();
            
            showNotification('‚úÖ Portfolio rebalanced based on AI scores', 'success');
        }

        async function generateLiveReport() {
            const button = document.getElementById('reportBtn');
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div>Generating...';
            
            try {
                showNotification('üìä Generating comprehensive live report...', 'info');
                
                if (config.openaiKey) {
                    const portfolioSummary = portfolioState.holdings.map(h => 
                        `${h.symbol}: ${h.allocation.toFixed(1)}% allocation, ${h.currentPrice?.toFixed(2)} price, ${h.dayChangePercent?.toFixed(2)}% day change, AI Score: ${h.aiScore?.toFixed(1)}`
                    ).join('\n');

                    const prompt = `
                    Generate a comprehensive portfolio analysis report in HTML format:

                    Portfolio Data:
                    ${portfolioSummary}

                    Include:
                    1. Executive Summary
                    2. Performance Analysis
                    3. Risk Assessment
                    4. AI Recommendations
                    5. Market Outlook
                    6. Action Items

                    Format as a complete HTML document with professional styling.
                    `;

                    const report = await makeOpenAIRequest([
                        { role: "user", content: prompt }
                    ]);

                    // Open report in new window
                    const reportWindow = window.open('', '_blank');
                    reportWindow.document.write(report);
                    reportWindow.document.close();
                    
                    showNotification('‚úÖ Live report generated and opened in new tab', 'success');
                } else {
                    showNotification('‚ùå OpenAI API key required for report generation', 'error');
                }
                
            } catch (error) {
                console.error('Report generation error:', error);
                showNotification(`‚ùå Report generation failed: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        async function updateMarketData() {
            const button = document.getElementById('updateBtn');
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div>Updating...';
            
            try {
                showNotification('üîÑ Updating market data...', 'info');
                
                // Update stock prices
                for (let holding of portfolioState.holdings) {
                    const newData = await getStockData(holding.symbol);
                    if (newData) {
                        holding.currentPrice = newData.price;
                        holding.dayChange = newData.change;
                        holding.dayChangePercent = newData.changePercent;
                    }
                }
                
                // Update news
                await loadMarketNews();
                
                // Recalculate AI scores
                await calculateAIScores();
                
                updatePortfolioDisplay();
                updatePerformanceMetrics();
                updateCharts();
                updateLastUpdateTime();
                
                showNotification('‚úÖ Market data updated successfully', 'success');
                
            } catch (error) {
                console.error('Market data update error:', error);
                showNotification(`‚ùå Update failed: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // Start real-time updates
        function startRealTimeUpdates() {
            // Update every 30 seconds
            setInterval(async () => {
                if (config.initialized) {
                    try {
                        await updateMarketData();
                    } catch (error) {
                        console.error('Background update error:', error);
                    }
                }
            }, config.updateInterval);
        }

        // Utility functions
        function updateSystemStatus(message, isActive) {
            document.getElementById('systemStatusText').textContent = message;
            const indicator = document.getElementById('systemStatus');
            indicator.className = isActive ? 'status-indicator' : 'status-indicator error';
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
            portfolioState.lastUpdate = now;
        }

        function showMessage(message, type) {
            console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
            
            const messagesDiv = document.getElementById('apiMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 
                                 type === 'success' ? 'success-message' : 
                                 type === 'warning' ? 'warning-message' : 'info-message';
            messageDiv.innerHTML = message;
            messagesDiv.appendChild(messageDiv);

            // Auto-remove after 5 seconds (except errors)
            if (type !== 'error') {
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 5000);
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                background: ${type === 'success' ? '#4CAF50' : type === 'info' ? '#2196F3' : '#f44336'};
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                max-width: 300px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .warning-message {
                background: #fff3cd;
                color: #856404;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid #ffeaa7;
                margin: 10px 0;
            }
            .info-message {
                background: #e3f2fd;
                color: #1976d2;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid #90caf9;
                margin: 10px 0;
            }
        `;
        document.head.appendChild(style);

        // Initialize on page load
        window.addEventListener('load', function() {
            updateSystemStatus('Ready for API configuration', false);
        });
    </script>
</body>
</html>
