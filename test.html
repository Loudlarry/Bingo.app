<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo - AI Enhanced</title>
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bingo">
    
    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: #f9fafb;
            min-height: 100vh;
            padding: env(safe-area-inset-top, 20px) 16px env(safe-area-inset-bottom, 20px);
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-top: 20px;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #f3f4f6;
            flex: 1;
            text-align: center;
        }
        
        .header .subtitle {
            font-size: 12px;
            color: #9ca3af;
            font-weight: 400;
            margin-top: 2px;
        }
        
        .sync-status {
            font-size: 10px;
            color: #9ca3af;
            margin-top: 2px;
        }
        
        .ai-status {
            font-size: 10px;
            color: #9ca3af;
            margin-top: 2px;
        }
        
        .sync-online { color: #10b981; }
        .sync-offline { color: #ef4444; }
        .sync-syncing { color: #fbbf24; }
        
        .ai-active { color: #8b5cf6; }
        .ai-error { color: #ef4444; }
        
        .settings-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #d1d5db;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .settings-menu {
            display: none;
            position: absolute;
            top: 50px;
            right: 0;
            background: #374151;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 100;
            min-width: 200px;
        }
        
        .settings-menu.show {
            display: block;
        }
        
        .settings-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
            font-size: 14px;
        }
        
        .settings-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .settings-item.ai-action {
            color: #8b5cf6;
        }
        
        .header-container {
            position: relative;
        }
        
        .ai-controls {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .ai-controls h3 {
            color: #8b5cf6;
            font-size: 16px;
            margin-bottom: 12px;
        }
        
        .ai-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .ai-btn {
            padding: 8px 16px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.4);
            color: #c4b5fd;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .ai-btn:hover:not(:disabled) {
            background: rgba(139, 92, 246, 0.3);
            transform: scale(1.05);
        }
        
        .ai-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .category {
            margin-bottom: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .category-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #fbbf24;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .entry {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .entry:last-child {
            margin-bottom: 0;
        }
        
        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .ticker {
            font-size: 18px;
            font-weight: 700;
            color: #60a5fa;
        }
        
        .ai-updated {
            font-size: 10px;
            color: #8b5cf6;
            margin-left: 8px;
        }
        
        .actions {
            display: flex;
            gap: 8px;
        }
        
        .edit-btn, .delete-btn, .refresh-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .edit-btn {
            background: #3b82f6;
            color: white;
        }
        
        .delete-btn {
            background: #ef4444;
            color: white;
        }
        
        .refresh-btn {
            background: #8b5cf6;
            color: white;
        }
        
        .entry-details {
            display: grid;
            gap: 8px;
            font-size: 14px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .detail-label {
            color: #d1d5db;
            font-weight: 500;
        }
        
        .detail-value {
            color: #f3f4f6;
            text-align: right;
            flex: 1;
            margin-left: 12px;
        }
        
        .price-change {
            font-weight: 600;
        }
        
        .price-up { color: #10b981; }
        .price-down { color: #ef4444; }
        .price-neutral { color: #fbbf24; }
        
        .risk-low { color: #10b981; }
        .risk-medium { color: #fbbf24; }
        .risk-high { color: #ef4444; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: #374151;
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            color: #f3f4f6;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #d1d5db;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #f3f4f6;
            font-size: 16px;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #10b981;
            color: white;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }
        
        .search-box {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #f3f4f6;
            font-size: 16px;
        }
        
        .search-box::placeholder {
            color: #9ca3af;
        }
        
        .config-form {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .config-form h4 {
            color: #f3f4f6;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .config-input {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #f3f4f6;
            font-size: 12px;
        }
        
        .config-btn {
            padding: 6px 12px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <div class="header">
                <div></div>
                <div>
                    <h1>üìà Bingo AI</h1>
                    <div class="subtitle">by Marc</div>
                    <div class="sync-status" id="syncStatus">üîÑ Connecting...</div>
                    <div class="ai-status" id="aiStatus">ü§ñ AI Ready</div>
                </div>
                <button class="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
                <div class="settings-menu" id="settingsMenu">
                    <div class="settings-item" onclick="showPasswordModal()">+ Add Entry</div>
                    <div class="settings-item" onclick="showPasswordModal('edit')">‚úèÔ∏è Edit Mode</div>
                    <div class="settings-item ai-action" onclick="showConfigModal()">ü§ñ Configure APIs</div>
                    <div class="settings-item ai-action" onclick="refreshAllData()">üîÑ Refresh All Data</div>
                    <div class="settings-item" onclick="exportData()">üì• Export Data</div>
                    <div class="settings-item" onclick="document.getElementById('importFile').click()">üì§ Import Data</div>
                    <div class="settings-item" onclick="resetData()">üîÑ Reset Data</div>
                    <div class="settings-item" onclick="toggleSettings()">Close</div>
                </div>
            </div>
        </div>
        
        <div class="ai-controls">
            <h3>ü§ñ AI Assistant</h3>
            <div class="ai-buttons">
                <button class="ai-btn" onclick="analyzeMarket()">üìä Market Analysis</button>
                <button class="ai-btn" onclick="generateRecommendations()">üí° Generate Ideas</button>
                <button class="ai-btn" onclick="updatePriceTargets()">üéØ Update Targets</button>
                <button class="ai-btn" onclick="riskAssessment()">‚ö†Ô∏è Risk Check</button>
            </div>
        </div>
        
        <input type="text" class="search-box" id="searchBox" placeholder="Search tickers, categories, or notes...">
        
        <div id="entriesContainer"></div>
    </div>
    
    <!-- Hidden file input for import -->
    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
    
    <!-- Config Modal -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Configure API Keys</h3>
            <div class="config-form">
                <h4>Alpha Vantage API Key (Free from alphavantage.co)</h4>
                <input type="text" class="config-input" id="alphaVantageKey" placeholder="Your Alpha Vantage API key">
                <h4>OpenAI API Key (Optional - for advanced AI analysis)</h4>
                <input type="password" class="config-input" id="openAIKey" placeholder="Your OpenAI API key (optional)">
                <button class="config-btn" onclick="saveAPIKeys()">Save Keys</button>
            </div>
            <div class="form-buttons">
                <button type="button" class="btn btn-secondary" onclick="hideConfigModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Regular Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Add New Entry</h3>
            <form id="entryForm">
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="category" required>
                        <option value="A. Monthly ‚Äî High Upside Picks">A. Monthly ‚Äî High Upside Picks</option>
                        <option value="B. Weekly ‚Äî 20%+ Potential">B. Weekly ‚Äî 20%+ Potential</option>
                        <option value="C. Plan to Beat S&P 500 Safely">C. Plan to Beat S&P 500 Safely</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ticker</label>
                    <input type="text" class="form-input" id="ticker" placeholder="e.g., AFRM" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Horizon</label>
                    <input type="text" class="form-input" id="horizon" placeholder="e.g., 1 Month, Next Week" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Expected Move</label>
                    <input type="text" class="form-input" id="expectedMove" placeholder="e.g., ¬±17.2% (implied)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Analyst Target / Notes</label>
                    <textarea class="form-textarea" id="analystTarget" placeholder="e.g., Target ~$84 vs ~$69 now"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Risk Level</label>
                    <select class="form-select" id="riskLevel" required>
                        <option value="üü¢ Low">üü¢ Low</option>
                        <option value="üü¢ Low‚ÄìMed">üü¢ Low‚ÄìMed</option>
                        <option value="üü° Medium">üü° Medium</option>
                        <option value="üü°/üî¥ Med‚ÄìHigh">üü°/üî¥ Med‚ÄìHigh</option>
                        <option value="üî¥ High">üî¥ High</option>
                    </select>
                </div>
                
                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Enter Password</h3>
            <form id="passwordForm">
                <div class="form-group">
                    <input type="password" class="form-input" id="passwordInput" placeholder="Enter password" required>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hidePasswordModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Continue</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCvTkVyK2zSZeW0XyWQ3OAlecUzk-Gg-70",
            authDomain: "bingo-trading-tracker.firebaseapp.com",
            projectId: "bingo-trading-tracker",
            storageBucket: "bingo-trading-tracker.firebasestorage.app",
            messagingSenderId: "564033694182",
            appId: "1:564033694182:web:288a93faa4cc672161ce27"
        };
        
        // Initialize Firebase
        let db;
        let isFirebaseConnected = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            isFirebaseConnected = true;
            updateSyncStatus('üü¢ Online');
        } catch (error) {
            console.warn('Firebase not configured, using localStorage:', error);
            updateSyncStatus('üî¥ Local Only');
        }
        
        // API Configuration
        let apiKeys = {
            alphaVantage: '',
            openAI: ''
        };
        
        // Load API keys from localStorage
        function loadAPIKeys() {
            const stored = localStorage.getItem('apiKeys');
            if (stored) {
                apiKeys = JSON.parse(stored);
            }
        }
        
        function saveAPIKeys() {
            const alphaVantageKey = document.getElementById('alphaVantageKey').value.trim();
            const openAIKey = document.getElementById('openAIKey').value.trim();
            
            apiKeys.alphaVantage = alphaVantageKey;
            apiKeys.openAI = openAIKey;
            
            localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
            updateAIStatus('ü§ñ APIs Configured');
            hideConfigModal();
        }
        
        // Default data (same as before)
        const defaultEntries = [
            {
                id: 1,
                category: "A. Monthly ‚Äî High Upside Picks",
                ticker: "AFRM",
                horizon: "1 Month",
                expectedMove: "¬±17.2% (implied)",
                analystTarget: "Target ~$84 vs ~$69 now",
                riskLevel: "üü° Medium",
                currentPrice: null,
                priceChange: null,
                lastUpdated: null
            },
            {
                id: 2,
                category: "A. Monthly ‚Äî High Upside Picks",
                ticker: "APP",
                horizon: "1 Month",
                expectedMove: "+14.3% post-earnings",
                analystTarget: "Analyst targets ~$491 vs ~$463 now",
                riskLevel: "üü° Medium",
                currentPrice: null,
                priceChange: null,
                lastUpdated: null
            }
            // Add other default entries as needed
        ];
        
        // Data storage
        let entries = [];
        let filteredEntries = [];
        let editingId = null;
        let editMode = false;
        
        // Status update functions
        function updateSyncStatus(status) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = status;
            statusEl.className = 'sync-status';
            
            if (status.includes('Online')) {
                statusEl.classList.add('sync-online');
            } else if (status.includes('Syncing')) {
                statusEl.classList.add('sync-syncing');
            } else {
                statusEl.classList.add('sync-offline');
            }
        }
        
        function updateAIStatus(status) {
            const statusEl = document.getElementById('aiStatus');
            statusEl.textContent = status;
            statusEl.className = 'ai-status';
            
            if (status.includes('Active') || status.includes('Configured')) {
                statusEl.classList.add('ai-active');
            } else if (status.includes('Error')) {
                statusEl.classList.add('ai-error');
            }
        }
        
        // Stock data fetching functions
        async function fetchStockData(ticker) {
            if (!apiKeys.alphaVantage) {
                throw new Error('Alpha Vantage API key not configured');
            }
            
            try {
                const response = await fetch(
                    `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${ticker}&apikey=${apiKeys.alphaVantage}`
                );
                const data = await response.json();
                
                if (data['Error Message']) {
                    throw new Error(`API Error: ${data['Error Message']}`);
                }
                
                const quote = data['Global Quote'];
                if (!quote) {
                    throw new Error('No data returned for ticker');
                }
                
                return {
                    symbol: quote['01. Symbol'],
                    price: parseFloat(quote['05. price']),
                    change: parseFloat(quote['09. change']),
                    changePercent: quote['10. change percent']
                };
            } catch (error) {
                console.error(`Error fetching data for ${ticker}:`, error);
                throw error;
            }
        }
        
        // AI analysis functions using simple algorithms (free alternative to OpenAI)
        function analyzeVolatility(priceData) {
            // Simple volatility calculation based on price changes
            const absChange = Math.abs(priceData.change);
            const price = priceData.price;
            const volatility = (absChange / price) * 100;
            
            if (volatility > 5) return "üî¥ High";
            if (volatility > 2) return "üü° Medium";
            return "üü¢ Low";
        }
        
        function generateSimpleAnalysis(ticker, priceData) {
            const change = priceData.change;
            const changePercent = parseFloat(priceData.changePercent.replace('%', ''));
            
            let momentum = "Neutral";
            if (changePercent > 2) momentum = "Strong Bullish";
            else if (changePercent > 0.5) momentum = "Bullish";
            else if (changePercent < -2) momentum = "Strong Bearish";
            else if (changePercent < -0.5) momentum = "Bearish";
            
            return `Current: $${priceData.price.toFixed(2)} (${priceData.changePercent}) - ${momentum} momentum`;
        }
        
        // Enhanced AI functions
        async function refreshStockData(entryId) {
            const entry = entries.find(e => e.id === entryId);
            if (!entry) return;
            
            const ticker = entry.ticker.replace(/[‚≠ê]/g, '').trim();
            
            try {
                updateAIStatus('üîÑ Fetching data...');
                const stockData = await fetchStockData(ticker);
                
                // Update entry with new data
                entry.currentPrice = stockData.price;
                entry.priceChange = stockData.change;
                entry.changePercent = stockData.changePercent;
                entry.lastUpdated = new Date().toLocaleString();
                entry.aiAnalysis = generateSimpleAnalysis(ticker, stockData);
                entry.volatilityRisk = analyzeVolatility(stockData);
                
                saveToFirebase();
                applySearch();
                renderEntries();
                updateAIStatus('ü§ñ Data Updated');
            } catch (error) {
                updateAIStatus('‚ùå Update Failed');
                alert(`Failed to update ${ticker}: ${error.message}`);
            }
        }
        
        async function refreshAllData() {
            if (!apiKeys.alphaVantage) {
                alert('Please configure your Alpha Vantage API key first');
                showConfigModal();
                return;
            }
            
            updateAIStatus('üîÑ Updating all entries...');
            const buttons = document.querySelectorAll('.ai-btn');
            buttons.forEach(btn => btn.disabled = true);
            
            for (let i = 0; i < entries.length; i++) {
                const entry = entries[i];
                const ticker = entry.ticker.replace(/[‚≠ê]/g, '').trim();
                
                if (ticker && ticker !== 'Strategy Mix') {
                    try {
                        const stockData = await fetchStockData(ticker);
                        entry.currentPrice = stockData.price;
                        entry.priceChange = stockData.change;
                        entry.changePercent = stockData.changePercent;
                        entry.lastUpdated = new Date().toLocaleString();
                        entry.aiAnalysis = generateSimpleAnalysis(ticker, stockData);
                        entry.volatilityRisk = analyzeVolatility(stockData);
                        
                        // Rate limiting: wait 12 seconds between requests for free tier
                        if (i < entries.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 12000));
                        }
                    } catch (error) {
                        console.error(`Failed to update ${ticker}:`, error);
                    }
                }
            }
            
            saveToFirebase();
            applySearch();
            renderEntries();
            updateAIStatus('‚úÖ All data updated');
            buttons.forEach(btn => btn.disabled = false);
        }
        
        async function analyzeMarket() {
            updateAIStatus('üîÑ Analyzing market...');
            
            // Simple market analysis based on available data
            let bullishCount = 0;
            let bearishCount = 0;
            let totalEntries = 0;
            
            entries.forEach(entry => {
                if (entry.priceChange !== null) {
                    totalEntries++;
                    if (entry.priceChange > 0) bullishCount++;
                    else if (entry.priceChange < 0) bearishCount++;
                }
            });
            
            if (totalEntries === 0) {
                alert('No price data available. Please refresh stock data first.');
                return;
            }
            
            const bullishPercent = ((bullishCount / totalEntries) * 100).toFixed(1);
            const sentiment = bullishCount > bearishCount ? 'Bullish' : 'Bearish';
            
            alert(`Market Analysis:\n${bullishCount}/${totalEntries} positions are up (${bullishPercent}%)\nOverall sentiment: ${sentiment}`);
            updateAIStatus('üìä Analysis complete');
        }
        
        function generateRecommendations() {
            updateAIStatus('üîÑ Generating ideas...');
            
            const recommendations = [
                "Consider diversifying across different risk levels",
                "Monitor high volatility stocks more closely",
                "Review positions that haven't moved as expected",
                "Look for earnings catalysts in upcoming weeks",
                "Consider profit-taking on strong performers"
            ];
            
            const randomRec = recommendations[Math.floor(Math.random() * recommendations.length)];
            alert(`AI Recommendation: ${randomRec}`);
            updateAIStatus('üí° Ideas generated');
        }
        
        function updatePriceTargets() {
            updateAIStatus('üîÑ Updating targets...');
            
            entries.forEach(entry => {
                if (entry.currentPrice && entry.analystTarget) {
                    const currentPrice = entry.currentPrice;
                    const targetMatch = entry.analystTarget.match(/\$(\d+)/);
                    if (targetMatch) {
                        const target = parseFloat(targetMatch[1]);
                        const upside = ((target - currentPrice) / currentPrice * 100).toFixed(1);
                        entry.calculatedUpside = `${upside}% upside to target`;
                    }
                }
            });
            
            saveToFirebase();
            applySearch();
            renderEntries();
            updateAIStatus('üéØ Targets updated');
        }
        
        function riskAssessment() {
            updateAIStatus('üîÑ Assessing risk...');
            
            let highRiskCount = 0;
            let totalPositions = entries.length;
            
            entries.forEach(entry => {
                if (entry.riskLevel && entry.riskLevel.includes('üî¥')) {
                    highRiskCount++;
                }
            });
            
            const riskPercent = ((highRiskCount / totalPositions) * 100).toFixed(1);
            let riskMessage = '';
            
            if (riskPercent > 50) {
                riskMessage = 'High risk exposure - consider rebalancing';
            } else if (riskPercent > 30) {
                riskMessage = 'Moderate risk exposure - monitor closely';
            } else {
                riskMessage = 'Risk levels appear balanced';
            }
            
            alert(`Risk Assessment:\n${highRiskCount}/${totalPositions} high-risk positions (${riskPercent}%)\n${riskMessage}`);
            updateAIStatus('‚ö†Ô∏è Risk assessed');
        }
        
        // Firebase storage functions (same as before)
        async function saveToFirebase() {
            if (!isFirebaseConnected) {
                saveToLocalStorage();
                return;
            }
            
            try {
                updateSyncStatus('üîÑ Syncing...');
                await db.collection('bingo').doc('entries').set({ data: entries });
                updateSyncStatus('üü¢ Synced');
                console.log('Data saved to Firebase');
            } catch (error) {
                console.error('Firebase save failed:', error);
                updateSyncStatus('üî¥ Sync Failed');
                saveToLocalStorage();
            }
        }
        
        async function loadFromFirebase() {
            if (!isFirebaseConnected) {
                loadFromLocalStorage();
                return;
            }
            
            try {
                updateSyncStatus('üîÑ Loading...');
                const doc = await db.collection('bingo').doc('entries').get();
                
                if (doc.exists) {
                    const data = doc.data();
                    if (data.data && Array.isArray(data.data)) {
                        entries = data.data;
                        updateSyncStatus('üü¢ Online');
                        console.log('Data loaded from Firebase');
                    } else {
                        throw new Error('Invalid data structure');
                    }
                } else {
                    entries = [...defaultEntries];
                    await saveToFirebase();
                }
            } catch (error) {
                console.error('Firebase load failed:', error);
                updateSyncStatus('üî¥ Local Only');
                loadFromLocalStorage();
            }
            
            applySearch();
        }
        
        function setupRealtimeListener() {
            if (!isFirebaseConnected) return;
            
            db.collection('bingo').doc('entries').onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.data && Array.isArray(data.data)) {
                        entries = data.data;
                        applySearch();
                        renderEntries();
                        updateSyncStatus('üü¢ Online');
                    }
                }
            }, (error) => {
                console.error('Realtime listener error:', error);
                updateSyncStatus('üî¥ Sync Error');
            });
        }
        
        function saveToLocalStorage() {
            try {
                localStorage.setItem('bingoEntries', JSON.stringify(entries));
                console.log('Data saved to localStorage');
            } catch (error) {
                console.error('Failed to save to localStorage:', error);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem('bingoEntries');
                if (stored) {
                    entries = JSON.parse(stored);
                    console.log('Data loaded from localStorage');
                } else {
                    entries = [...defaultEntries];
                    saveToLocalStorage();
                    console.log('Using default data');
                }
            } catch (error) {
                console.error('Failed to load from localStorage:', error);
                entries = [...defaultEntries];
            }
            applySearch();
        }
        
        // Data management functions
        function exportData() {
            const dataStr = JSON.stringify(entries, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'bingo_ai_data.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('Data exported successfully!');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        entries = importedData;
                        saveToFirebase();
                        applySearch();
                        renderEntries();
                        alert('Data imported successfully!');
                    } else {
                        alert('Invalid file format');
                    }
                } catch (error) {
                    alert('Failed to import data: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function resetData() {
            if (confirm('Are you sure you want to reset all data to defaults? This cannot be undone.')) {
                entries = [...defaultEntries];
                saveToFirebase();
                applySearch();
                renderEntries();
                alert('Data reset to defaults');
            }
        }
        
        // Enhanced render function with AI data
        function renderEntries() {
            const container = document.getElementById('entriesContainer');
            const groupedEntries = groupByCategory(filteredEntries);
            
            if (filteredEntries.length === 0) {
                container.innerHTML = '<div class="empty-state">No entries found. Try adjusting your search or add a new entry.</div>';
                return;
            }
            
            container.innerHTML = Object.entries(groupedEntries)
                .map(([category, entries]) => `
                    <div class="category">
                        <div class="category-header">
                            ${category}
                            <span style="font-size: 14px; color: #9ca3af;">${entries.length} ${entries.length === 1 ? 'entry' : 'entries'}</span>
                        </div>
                        ${entries.map(entry => `
                            <div class="entry">
                                <div class="entry-header">
                                    <div>
                                        <div class="ticker">${entry.ticker}
                                            ${entry.lastUpdated ? '<span class="ai-updated">AI Updated</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="actions" id="actions-${entry.id}" style="display: ${editMode ? 'flex' : 'none'};">
                                        <button class="refresh-btn" onclick="refreshStockData(${entry.id})">üîÑ</button>
                                        <button class="edit-btn" onclick="editEntry(${entry.id})">Edit</button>
                                        <button class="delete-btn" onclick="deleteEntry(${entry.id})">Delete</button>
                                    </div>
                                </div>
                                <div class="entry-details">
                                    ${entry.currentPrice ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Current Price:</span>
                                        <span class="detail-value price-change ${entry.priceChange > 0 ? 'price-up' : entry.priceChange < 0 ? 'price-down' : 'price-neutral'}">
                                            ${entry.currentPrice.toFixed(2)} (${entry.changePercent})
                                        </span>
                                    </div>
                                    ` : ''}
                                    <div class="detail-row">
                                        <span class="detail-label">Horizon:</span>
                                        <span class="detail-value">${entry.horizon}</span>
                                    </div>
                                    ${entry.expectedMove ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Expected Move:</span>
                                        <span class="detail-value">${entry.expectedMove}</span>
                                    </div>
                                    ` : ''}
                                    ${entry.analystTarget ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Target/Notes:</span>
                                        <span class="detail-value">${entry.analystTarget}</span>
                                    </div>
                                    ` : ''}
                                    ${entry.calculatedUpside ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Calculated Upside:</span>
                                        <span class="detail-value">${entry.calculatedUpside}</span>
                                    </div>
                                    ` : ''}
                                    ${entry.aiAnalysis ? `
                                    <div class="detail-row">
                                        <span class="detail-label">AI Analysis:</span>
                                        <span class="detail-value">${entry.aiAnalysis}</span>
                                    </div>
                                    ` : ''}
                                    <div class="detail-row">
                                        <span class="detail-label">Risk:</span>
                                        <span class="detail-value ${getRiskClass(entry.riskLevel)}">${entry.riskLevel}</span>
                                    </div>
                                    ${entry.lastUpdated ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Last Updated:</span>
                                        <span class="detail-value" style="font-size: 11px;">${entry.lastUpdated}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `).join('');
        }
        
        function groupByCategory(entries) {
            const grouped = {};
            entries.forEach(entry => {
                if (!grouped[entry.category]) {
                    grouped[entry.category] = [];
                }
                grouped[entry.category].push(entry);
            });
            return grouped;
        }
        
        function getRiskClass(riskLevel) {
            if (riskLevel.includes('üü¢')) return 'risk-low';
            if (riskLevel.includes('üü°') && riskLevel.includes('üî¥')) return 'risk-high';
            if (riskLevel.includes('üü°')) return 'risk-medium';
            if (riskLevel.includes('üî¥')) return 'risk-high';
            return '';
        }
        
        // Modal functions
        function toggleSettings() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('show');
        }
        
        function showConfigModal() {
            const modal = document.getElementById('configModal');
            modal.classList.add('show');
            
            // Pre-fill existing keys
            document.getElementById('alphaVantageKey').value = apiKeys.alphaVantage || '';
            document.getElementById('openAIKey').value = apiKeys.openAI || '';
        }
        
        function hideConfigModal() {
            const modal = document.getElementById('configModal');
            modal.classList.remove('show');
        }
        
        function showPasswordModal(action = 'add') {
            toggleSettings();
            const modal = document.getElementById('passwordModal');
            modal.classList.add('show');
            modal.setAttribute('data-action', action);
            
            document.getElementById('passwordInput').value = '';
            setTimeout(() => {
                document.getElementById('passwordInput').focus();
            }, 100);
        }
        
        function hidePasswordModal() {
            const modal = document.getElementById('passwordModal');
            modal.classList.remove('show');
            document.getElementById('passwordInput').value = '';
        }
        
        function toggleEditMode() {
            editMode = !editMode;
            renderEntries();
        }
        
        function showModal(entryId = null) {
            const modal = document.getElementById('modal');
            const form = document.getElementById('entryForm');
            const title = document.getElementById('modalTitle');
            
            editingId = entryId;
            
            if (entryId) {
                title.textContent = 'Edit Entry';
                const entry = entries.find(e => e.id === entryId);
                if (entry) {
                    document.getElementById('category').value = entry.category;
                    document.getElementById('ticker').value = entry.ticker;
                    document.getElementById('horizon').value = entry.horizon;
                    document.getElementById('expectedMove').value = entry.expectedMove || '';
                    document.getElementById('analystTarget').value = entry.analystTarget || '';
                    document.getElementById('riskLevel').value = entry.riskLevel;
                }
            } else {
                title.textContent = 'Add New Entry';
                form.reset();
            }
            
            modal.classList.add('show');
        }
        
        function hideModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('show');
            editingId = null;
        }
        
        function editEntry(id) {
            showModal(id);
        }
        
        function deleteEntry(id) {
            if (confirm('Are you sure you want to delete this entry?')) {
                entries = entries.filter(e => e.id !== id);
                saveToFirebase();
                applySearch();
                renderEntries();
            }
        }
        
        // Search functionality
        function applySearch() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            if (!searchTerm.trim()) {
                filteredEntries = [...entries];
            } else {
                filteredEntries = entries.filter(entry =>
                    entry.ticker.toLowerCase().includes(searchTerm) ||
                    entry.category.toLowerCase().includes(searchTerm) ||
                    (entry.analystTarget && entry.analystTarget.toLowerCase().includes(searchTerm)) ||
                    entry.horizon.toLowerCase().includes(searchTerm)
                );
            }
        }
        
        // Event listeners
        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            const modal = document.getElementById('passwordModal');
            const action = modal.getAttribute('data-action') || 'add';
            
            if (password === '4321') {
                hidePasswordModal();
                if (action === 'edit') {
                    toggleEditMode();
                } else {
                    showModal();
                }
            } else {
                alert('Incorrect password');
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        });
        
        document.getElementById('entryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                category: document.getElementById('category').value,
                ticker: document.getElementById('ticker').value,
                horizon: document.getElementById('horizon').value,
                expectedMove: document.getElementById('expectedMove').value,
                analystTarget: document.getElementById('analystTarget').value,
                riskLevel: document.getElementById('riskLevel').value
            };
            
            if (editingId) {
                const entryIndex = entries.findIndex(e => e.id === editingId);
                if (entryIndex !== -1) {
                    entries[entryIndex] = { ...entries[entryIndex], ...formData };
                }
            } else {
                const newId = Math.max(...entries.map(e => e.id), 0) + 1;
                entries.push({ 
                    id: newId, 
                    ...formData,
                    currentPrice: null,
                    priceChange: null,
                    lastUpdated: null
                });
            }
            
            saveToFirebase();
            applySearch();
            renderEntries();
            hideModal();
        });
        
        document.getElementById('searchBox').addEventListener('input', function() {
            applySearch();
            renderEntries();
        });
        
        // Modal click handlers
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) hideModal();
        });
        
        document.getElementById('passwordModal').addEventListener('click', function(e) {
            if (e.target === this) hidePasswordModal();
        });
        
        document.getElementById('configModal').addEventListener('click', function(e) {
            if (e.target === this) hideConfigModal();
        });
        
        // Close settings menu when clicking outside
        document.addEventListener('click', function(e) {
            const settingsBtn = e.target.closest('.settings-btn');
            const settingsMenu = document.getElementById('settingsMenu');
            
            if (!settingsBtn && !settingsMenu.contains(e.target)) {
                settingsMenu.classList.remove('show');
            }
        });
        
        // Initialize app
        async function initApp() {
            loadAPIKeys();
            await loadFromFirebase();
            renderEntries();
            
            if (isFirebaseConnected) {
                setupRealtimeListener();
            }
            
            // Check if API keys are configured
            if (apiKeys.alphaVantage) {
                updateAIStatus('ü§ñ AI Ready');
            } else {
                updateAIStatus('‚öôÔ∏è Configure APIs');
            }
        }
        
        // Start the app
        initApp();
    </script>
</body>
</html>
